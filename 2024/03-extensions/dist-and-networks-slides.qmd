---
title: Extensions
author: Renata Diaz 
date: 2024-06-20
format: 
  uaz-revealjs:
  # revealjs:
    incremental: true
css: custom.css
---

```{r, echo = F}
library(dplyr)
library(ggdist)
library(ggplot2)
library(distributional)
library(palmerpenguins)

theme_set(theme_bw())

penguins <- penguins |>
  filter(!is.na(sex))
```

# `ggdist` for distributions {.smaller}

-   Easily add nuance to density/histogram/ribbon plots
-   Particularly useful for:
    -   Sample data
    -   Fitted values + uncertainty
    -   Frequentist or Bayesian parameter distributions

## `slabinterval`

```{r slabinterval, echo = T}
penguins %>%
  ggplot(aes(x = body_mass_g, y = species)) +
  stat_slabinterval()

```

::: notes
-   This plots a "halfeye" plot with a density distribution and a line at the bottom showing the mean and quantiles of the data.
-   Note that we didn't have to create any new objects; stat_slabinterval automatically calculates densities and summary statistics. There are corresponding geom\_\* functions for already summarized data.
-   Other plot types within ggdist are variations on the stat_slabinterval theme.
-   Often you'll want to use these shortcuts instead of building something up out of scratch.
:::

## Example: `dotsinterval`

```{r, echo = T}
penguins %>%
  ggplot(aes(x = body_mass_g, y = species)) +
  stat_dotsinterval()
```

## Example: `interval`

```{r, echo = T}
penguins %>%
  ggplot(aes(x = body_mass_g, y = species)) +
  stat_interval()
```

## Example: `interval`

```{r, echo = T}
penguins %>%
  ggplot(aes(x = body_mass_g, y = species)) +
  stat_interval() +
  scale_color_brewer()
```

## Combining elements: Raincloud plots

```{r, echo = T}
penguins %>%
  ggplot(aes(x = body_mass_g, y = species)) +
  stat_slabinterval() +
  stat_dotsinterval(side = "bottom")

```


## Ribbon plots

`stat_lineribbon` plots quantile intervals around a line automatically:

```{r, echo = T}
penguins %>%
  ggplot(aes(x = year, y = body_mass_g)) +
  stat_lineribbon() +
  scale_fill_brewer() +
  facet_wrap(vars(species))
```

## Ribbon plots

You can control the bands using the `.width` argument:

```{r, echo = T}
penguins %>%
  ggplot(aes(x = year, y = body_mass_g)) +
  stat_lineribbon(.width = c(.8, .97, .99)) +
  scale_fill_brewer() +
  facet_wrap(vars(species))
```

## Ribbon plots

`.width = ppoints()` creates a gradient:

```{r, echo = T}
penguins %>%
  ggplot(aes(x = year, y = body_mass_g, fill = after_stat(.width))) +
  stat_lineribbon(.width = ppoints(100)) +
  scale_fill_distiller() +
  facet_wrap(vars(species))
```

## Visualizing frequentist model output

Combined with the `broom` and `distributional` packages, `ggdist` can display frequentist model uncertainty.

## Visualizing frequentist model output

```{r, echo = T}

library(broom)
library(distributional)

penguin_lm <- lm(body_mass_g ~  species, data = penguins)

broom::tidy(penguin_lm)

```

## Visualizing frequentist model output

```{r, echo = T}

broom::tidy(penguin_lm) |>
  ggplot(aes(y = term)) +
    stat_halfeye(
      aes(xdist = dist_student_t(df = df.residual(penguin_lm), mu = estimate, sigma = std.error))
    )
```

## Visualizing frequentist model output

-   You can also use ribbons to show uncertainty around lines of fit.
-   We'll need a linear model with a continuous predictor.
-   And we'll use `tidyr::expand` and `broom::augment` to get the predicted line of fit from the model.

## Visualizing frequentist model output

```{r, echo = T}

penguin_lm_cont <- lm(body_mass_g ~  year + species, data = penguins)

penguin_lm_cont_fitted <- penguins %>%
  group_by(species) %>%
  tidyr::expand(year = seq(min(year), max(year), length.out = 3)) %>%
  augment(penguin_lm_cont, newdata = ., se_fit = TRUE) 

head(penguin_lm_cont_fitted) 

```

## Visualizing frequentist model output

```{r, echo = T}

  ggplot(penguin_lm_cont_fitted, aes(x = year)) +
  stat_lineribbon(
    aes(ydist = dist_student_t(df = df.residual(penguin_lm_cont), mu = .fitted, sigma = .se.fit))) +
  facet_wrap(vars(species)) +
  scale_fill_brewer() 

```

## Visualizing Bayesian model components

-   `ggdist` plots are great for visualizing Bayesian model components:
    -   priors
    -   posterior draws
    -   posterior predictions
-   We can fit a simple Bayesian linear model and visualize the posterior...

## Fitting a model

```{r, echo = F}
library(brms)
library(tidybayes)

load(here::here("2024", "03-extensions", "penguins_brm.RDS"))
```

```{r, echo = T, eval = F}

library(brms)
library(tidybayes)

penguins_brm <- brm(body_mass_g ~ species, data = penguins, iter = 1000)

```

## Extracting draws from the posterior

```{r, echo = T}
penguins_brm %>%
tidybayes::gather_draws(
c(b_Intercept,
b_speciesChinstrap,
b_speciesGentoo)
) |>
head() 
```


## Posterior draws rainclouds

```{r, echo = T}
penguins_brm |>
tidybayes::gather_draws(
c(b_Intercept,
b_speciesChinstrap,
b_speciesGentoo)) %>%
ggplot(aes(y = .variable, x = .value)) +  geom_dotsinterval(side = "bottom", dotsize = .05) + 
stat_slabinterval() 
```

## Takeaways

-   `ggdist` contains `geom` and `stat` functions for plotting distributions.
-   Slab functions show variations on density plots.
-   Ribbons show variation around a line.
-   `ggdist` plays nicely with Bayesian and frequentist modeling frameworks.

## For more

- [`ggdist` documentation here](https://mjskay.github.io/ggdist/index.html)
- [`tidybayes` documentation here](http://mjskay.github.io/tidybayes/)

# Relational data with `ggraph`

## `ggraph` {.smaller}

-   For plotting networks, graphs, and trees
-   Adds **layouts** and geoms for nodes and edges
-   Integrates with [`tidygraph`](https://ggraph.data-imaginist.com/articles/tidygraph.html) to wrap around numerous other graph object types (`igraph`, `dedrogram`, `hclust`, `graph`, `phylo`, ...)

## Example: Mouse data

Begin by loading network data, in this case from the `graphml` format.

Data from [So et al. 2015](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0134509), in the [Animal Social Networks Repository](https://github.com/bansallab/asnr/tree/master).

```{r, echo = TRUE}

library(igraph)
library(ggraph)
library(tidygraph)

mouse_sniffing <- read_graph(here::here("2024", "03-extensions", "mouse_so_grooming_network.graphml"),
format = "graphml")

```

## Example: `as_tbl_graph`

`tidygraph::as_tbl_graph` standardizes different graph storage formats.

```{r, echo = T}
mouse_graph <- mouse_sniffing |>
as_tbl_graph() 
```

## Plotting mouse sniffing data

```{r, echo = T}
ggraph(mouse_graph, layout = 'kk') + 
    geom_edge_fan() + 
    geom_node_point() +
    theme_minimal() +
    ggtitle("Mouse sniffs")
```

## Alternate layouts

```{r, echo = T}
ggraph(mouse_graph, layout = 'eigen') + 
    geom_edge_fan() + 
    geom_node_point() +
    theme_minimal() +
    ggtitle("Mouse sniffs")
```

## Alternate layouts

```{r, echo = T}
ggraph(mouse_graph, layout = 'linear', circular = TRUE) + 
    geom_edge_fan() + 
    geom_node_point() +
    theme_minimal() +
    ggtitle("Mouse sniffs")
```

## Example: phylogenies

-   `ggraph` can plot phylogenetic trees.
-   We'll get a phylogeny using the R Open Tree of Life (`rotl`) and plot it.

## Getting a phylogeny

![](krat.jpg){fig-align="center"}

## Getting a phylogeny

```{r, echo = TRUE, warning = F}
library(rotl)
rodent_id <- tnrs_match_names("Heteromyidae")
rodent_tree <- tol_subtree(ott_id = ott_id(rodent_id))
rodent_tree$node.label <- c(1:64)
class(rodent_tree)
```

## Convert the phylogeny to a graph

```{r, echo = T}

rodent_graph <- as_tbl_graph(rodent_tree)

```

## Dendrogram

```{r, echo = T}

ggraph(rodent_graph, "dendrogram") +
geom_edge_link()

```

## Unrooted tree

```{r, echo = T}

ggraph(rodent_graph, "unrooted") +
geom_edge_link()

```

## Takeaways

- `ggraph` can plot many different types of network objects.
- Use `as_tbl_graph` to convert graphs to `ggraph`-compatible objects.
- Layouts strongly determine the appearance and interpretability of a graph.

## For more

- [`ggraph` documentation](https://ggraph.data-imaginist.com/index.html)
- [`tidygraph` documentation](https://tidygraph.data-imaginist.com/)
- [`igraph` R package documentation](https://r.igraph.org/)
- [`rotl` documentation](https://cran.r-project.org/web/packages/rotl/rotl.pdf)

## Data sources

Pratha Sah, JosÃ© David Mendez, Shweta Bansal.
A multi-species respository of social networks.
Scientific Data, 6:44 (2019)

So, N., Franks, B., Lim, S., and Curley, J.P.
2015.
A social network approach reveals associations between mouse social dominance and brain gene expression.
PlosOne 10(7):e0134509
